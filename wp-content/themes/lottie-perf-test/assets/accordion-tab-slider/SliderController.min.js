import SwipeListener from"./SwipeListener.min.js";import Timer from"./Timer.min.js";export default class SliderController{constructor(model,views,options,loop=true){const{touchChangeThreshold,autoSlideSpeed,autoplay,listeningElement}=options;this._model=model;this._views=views;this._touchChangeThreshold=touchChangeThreshold;this._autoSlideSpeed=autoSlideSpeed;this._autoplay=autoplay;this._loop=loop;this._progressValue=0;this._init()}_init=()=>{this.timer=new Timer(this._autoSlideSpeed,100,{});this.timer.subscribe(progress=>{this._updateProgress(progress)});this._views.forEach(view=>{this._bindEvents(view);this._instanciateSwipeListener(view)});this._model.goToNext()};_updateProgress=progress=>{this._progressValue=progress;this._model.updateProgress(this._progressValue);if(this._progressValue>=100){this._model.goToNext()}};_bindEvents=view=>{if(!view)return;if(view.options.disableInteraction)return;switch(view.type){case"navigation":this._bindEventsToNavigation(view);break;case"pagination":this._bindEventsToPagination(view);break;case"slides":this._bindEventsToSlides(view);this._bindSlideClickEvent(view);break}};_bindEventsToNavigation=view=>{view.container.childNodes.forEach(child=>{child.addEventListener("click",e=>{this._pauseAutoSlide();if(child.classList.contains("js-nextBtn")){this._model.goToNext()}else if(child.classList.contains("js-prevBtn")){this._model.goToPrev()}if(!this._autoplay)return;this.timer.stop()})});if(view.options.disablePauseAndResumeOnMouseEnterAndLeave)return;this._pauseAndResumeOnMouseEnterAndLeave(view)};_bindEventsToPagination=view=>{view.container.childNodes.forEach(child=>{child.addEventListener("click",e=>{this._pauseAutoSlide();if(e.currentTarget.dataset.index==this._model.currentIndex)return;const currentPaginationIndex=parseInt(e.currentTarget.dataset.index);this._model.setCurrentIndex(currentPaginationIndex);if(!this._autoplay)return;this.timer.stop()})});if(view.options.disablePauseAndResumeOnMouseEnterAndLeave)return;this._pauseAndResumeOnMouseEnterAndLeave(view)};_bindEventsToSlides=view=>{if(!view.options.disableSwipe){view.container.addEventListener("touchstart",event=>{this._interactionStart(event,view)});view.container.addEventListener("mousedown",event=>{this._interactionStart(event,view)});view.container.addEventListener("touchend",event=>{this._interactionEnd(event,view)});view.container.addEventListener("mouseup",event=>{this._interactionEnd(event,view)})}if(view.options.disablePauseAndResumeOnMouseEnterAndLeave)return;this._pauseAndResumeOnMouseEnterAndLeave(view)};_pauseAndResumeOnMouseEnterAndLeave=view=>{const isTouchDevice="ontouchstart"in window||navigator.maxTouchPoints>0;if(isTouchDevice)return;const elem=view.options.listeningElement;if(elem){elem.addEventListener("mouseenter",()=>{this._pauseAutoSlide()});elem.addEventListener("mouseleave",()=>{this._resumeAutoSlide()})}else{view.container.childNodes.forEach(child=>{child.addEventListener("mouseenter",e=>{if(e.target.dataset.index!=this._model.currentIndex)return;this._pauseAutoSlide()});child.addEventListener("mouseleave",e=>{if(e.target.dataset.index!=this._model.currentIndex)return;this._resumeAutoSlide()})})}};_interactionStart=(event,view)=>{this._pauseAutoSlide(view);view.swipeListener.start(event);event.stopPropagation()};_interactionEnd=(event,view)=>{const direction=view.swipeListener.end(event);const totalItems=this._loop?99999999:Array.from(view.container.childNodes).length-1;const currentIndex=this._loop?1:this._model.currentIndex;if(direction>0&&this._model.currentIndex<totalItems){this._model.goToNext()}else if(direction<0&&currentIndex>0){this._model.goToPrev()}event.stopPropagation();if(!this._autoplay)return;this._resumeAutoSlide()};_instanciateSwipeListener=view=>{if(!view)return;if(view.options.disableSwipe||view.options.disableInteraction)return;view.swipeListener=new SwipeListener(view.container,this._touchChangeThreshold)};_pauseAutoSlide=()=>{this.timer.pause()};_resumeAutoSlide=()=>{this.timer.resume()};_bindSlideClickEvent(view){view.container.childNodes.forEach(child=>{child.addEventListener("click",e=>{this._pauseAutoSlide();if(e.currentTarget.dataset.index==this._model.currentIndex)return;const currentSlideIndex=parseInt(e.currentTarget.dataset.index);this._model.setCurrentIndex(currentSlideIndex);if(!this._autoplay)return;this.timer.stop()})})}}